<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>Admin Users</title>

  <link rel="stylesheet" th:href="@{/css/main.css}">
  <link rel="stylesheet" th:href="@{/css/admin/users.css}">
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">


</head>
<body>

<header class="topbar">
  <nav class="nav">
    <div class="nav-left">
      <a class="brand" th:href="@{/home}">PulseX</a>
      <a sec:authorize="isAuthenticated()" th:href="@{/trade}">Trade</a>
      <a sec:authorize="isAuthenticated()" th:href="@{/dashboard}">Dashboard</a>
      <a sec:authorize="isAuthenticated()" th:href="@{/indicator}">Indicators</a>
      <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin/dashboard}" class="active">Admin</a>
      <a sec:authorize="isAuthenticated()" th:href="@{/profile}">Profile</a>
    </div>

    <ul class="nav-right" sec:authorize="isAuthenticated()">
      <li class="user"><span sec:authentication="name">user</span></li>
      <li>
        <form th:action="@{/logout}" method="post" style="display:inline">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <button type="submit" class="linklike">Logout</button>
        </form>
      </li>
    </ul>
  </nav>
</header>

<main class="container page admin-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <a th:href="@{/admin/dashboard}">Dashboard</a>
    <a th:href="@{/admin/users}" class="active">Users</a>
  </aside>

  <!-- Content -->
  <section class="card">
    <div class="topline">
      <form class="search" th:action="@{/admin/users}" method="get">
        <input name="q" th:value="${q}" placeholder="Search by ID / username / email">
        <button class="btn" type="submit">Search</button>
      </form>
      <div class="flash">
        <span th:if="${msg}" class="msg" th:text="${msg}"></span>
        <span th:if="${error}" class="error" th:text="${error}"></span>
      </div>
    </div>

    <table>
      <thead>
      <tr>
        <th style="width:80px;">ID</th>
        <th style="width:20%;">Username</th>
        <th>Email</th>
        <th style="width:120px;">Status</th>
        <th style="width:220px;">Roles</th>
        <th style="width:100px;"></th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="u : ${page.content}">
        <td th:text="${u.id}">1</td>
        <td th:text="${u.username}">neo</td>
        <td th:text="${u.email}">neo@matrix</td>
        <td>
          <span class="pill" th:text="${u.enabled} ? 'Active' : 'Blocked'">Active</span>
        </td>
        <td>
          <span class="pill" th:each="r : ${u.roles}" th:text="${r.name}" style="margin-right:6px;">ROLE_USER</span>
        </td>
        <td>
          <button class="btn" th:attr="data-id=${u.id}" onclick="openUserModal(this)">View</button>
        </td>
      </tr>
      <tr th:if="${page.content.isEmpty()}">
        <td colspan="6" class="muted">No users</td>
      </tr>
      </tbody>
    </table>

    <div class="pagination" th:with="p=${page.number}, last=${page.totalPages - 1}">
      <a class="btn"
         th:if="${p > 0}"
         th:href="@{/admin/users(q=${q}, page=${p - 1}, size=${page.size})}">Prev</a>

      <span class="muted">
        Page <span th:text="${p + 1}">1</span>
        / <span th:text="${page.totalPages == 0 ? 1 : page.totalPages}">1</span>
      </span>

      <a class="btn"
         th:if="${p < last}"
         th:href="@{/admin/users(q=${q}, page=${p + 1}, size=${page.size})}">Next</a>
    </div>
  </section>
</main>

<!-- Modal -->
<dialog id="userModal">
  <div class="modal-header">
    <strong>User details</strong>
    <button class="btn" type="button" onclick="closeUserModal()">✕</button>
  </div>
  <div class="modal-body" id="userModalBody">
    <div class="muted">Loading…</div>
  </div>
  <div class="modal-actions">
    <button class="btn" type="button" onclick="closeUserModal()">Close</button>
  </div>
</dialog>

<script>
  const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

  function openUserModal(btn){
    const id = btn.getAttribute('data-id');
    const modal = document.getElementById('userModal');
    const body  = document.getElementById('userModalBody');
    body.innerHTML = '<div class="muted">Loading…</div>';
    modal.showModal();

    fetch(`/admin/api/users/${id}`)
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(u => {
              const rolesSet = new Set(u.roles || []);

              body.innerHTML = `
          <div><b>ID:</b> ${u.id}</div>
          <div><b>Username:</b> ${u.username}</div>
          <div><b>Email:</b> ${u.email}</div>
          <div><b>Status:</b> <span class="pill">${u.enabled ? 'Active' : 'Blocked'}</span></div>
          <div><b>Created:</b> ${u.createdAt ?? ''}</div>
          <div><b>Last login:</b> ${u.lastLoginAt ?? ''}</div>

          <hr style="border-color:#232833">

          <form id="rolesForm">
            <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
              <label><input type="checkbox" name="roles" value="ROLE_USER" ${rolesSet.has('ROLE_USER') ? 'checked':''}> USER</label>
              <label><input type="checkbox" name="roles" value="ROLE_ADMIN" ${rolesSet.has('ROLE_ADMIN') ? 'checked':''}> ADMIN</label>
              <button class="btn" type="button" onclick="saveRoles(${u.id})">Save roles</button>
            </div>
          </form>

          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="btn ${u.enabled ? 'danger':''}" type="button" onclick="toggleEnabled(${u.id}, ${!u.enabled})">
              ${u.enabled ? 'Block' : 'Unblock'}
            </button>
          </div>

          <hr style="border-color:#232833">

          <form id="passwordForm" onsubmit="event.preventDefault(); changePassword(${u.id});">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <label class="muted" style="min-width:120px;">New password:</label>
              <input
                id="newPasswordInput"
                type="password"
                minlength="4"
                placeholder="min 4 chars"
                style="flex:1; min-width:220px; padding:10px 12px; border-radius:10px; border:1px solid #2a2f3a; background:#0f1216; color:#e6e9ef;"
                required
              />
              <button class="btn primary" type="submit">Change</button>
            </div>
            <div id="pwMsg" class="muted" style="margin-top:6px;"></div>
          </form>
        `;
            })
            .catch(() => body.innerHTML = '<div class="error">Failed to load user</div>');
  }

  function closeUserModal(){
    document.getElementById('userModal').close();
  }

  function toggleEnabled(id, enabled){
    const params = new URLSearchParams({ enabled: String(enabled) });
    fetch(`/admin/users/${id}/enabled`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
      body: params
    }).then(() => location.reload());
  }

  function saveRoles(id){
    const form = document.getElementById('rolesForm');
    const data = new FormData(form);
    const params = new URLSearchParams();
    for (const val of data.getAll('roles')) params.append('roles', val);

    fetch(`/admin/users/${id}/roles`, {
      method: 'POST',
      headers: { [csrfHeader]: csrfToken },
      body: params
    }).then(() => location.reload());
  }

  function changePassword(id){
    const input = document.getElementById('newPasswordInput');
    const msg = document.getElementById('pwMsg');

    const newPassword = (input?.value ?? '').trim();

    if (newPassword.length < 4){
      msg.textContent = 'Password must be at least 4 characters.';
      msg.style.color = '#ef5350';
      return;
    }

    msg.textContent = 'Saving...';
    msg.style.color = '#98a2b3';

    fetch(`/admin/users/${id}/password`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        [csrfHeader]: csrfToken
      },
      body: new URLSearchParams({ newPassword })
    })
            .then(r => {
              if (!r.ok) return r.text().then(t => Promise.reject(t || 'Failed'));
              return r.text();
            })
            .then(() => {
              msg.textContent = 'Password changed.';
              msg.style.color = '#66bb6a';
              input.value = '';
            })
            .catch((e) => {
              msg.textContent = typeof e === 'string' ? e : 'Failed to change password.';
              msg.style.color = '#ef5350';
            });
  }
</script>

<footer class="footer">© 2025 CryptoBot</footer>
</body>
</html>
